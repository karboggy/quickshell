name: Build Fedora
on:
  push:
      tags:
        - '*'
  workflow_dispatch:

jobs:
  fedora-42:
    name: Fedora 42
    runs-on: ubuntu-latest
    container: fedora:42
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Dependencies
        run: |
          dnf -y install \
            cmake \
            qt6-qtbase-devel \
            qt6-qtdeclarative-devel \
            qt6-qtshadertools-devel \
            spirv-tools \
            spirv-tools-devel \
            pkg-config \
            cli11-devel \
            qt6-qtwayland-devel \
            qt6-qtsvg-devel \
            ninja \
            jemalloc-devel \
            wayland-devel wayland-protocols-devel \
            libdrm-devel mesa-libgbm-devel \
            libxcb-devel \
            pipewire-devel \
            pam-devel \
            which
          dnf clean all

      - name: Build
        run: |
          cmake -GNinja -B build \
            -DDISTRIBUTOR=github \
            -DCRASH_REPORTER=OFF
          cmake --build build

      - name: Rename binary
        run: mv build/src/quickshell build/src/quickshell-fedora42

      - name: Upload artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: quickshell-fedora42
          path: build/src/quickshell-fedora42
          retention-days: 90

      - name: GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "quickshell ${{ github.ref_name }}"
          body: |
            **quickshell ${{ github.ref_name }}** â€” automatically built by GitHub Actions for Fedora

            **Download the binary**:
             - [Fedora 42](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/quickshell-fedora42)
          files: build/src/quickshell-fedora42
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
